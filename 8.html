<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1">
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">
<meta name="robots" content="index,follow">


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xmdhs&#39;s blog">
<meta name="twitter:description" content="就是一个博客">
<meta name="twitter:image:src" content="https://avatars0.githubusercontent.com/u/20377726">

<meta property="og:url" content="https://xmdhs.top">
<meta property="og:title" content="xmdhs&#39;s blog">
<meta property="og:description" content="就是一个博客">
<meta property="og:site_name" content="xmdhs&#39;s blog">
<meta property="og:image" content="https://avatars0.githubusercontent.com/u/20377726">
<meta property="og:type" content="website">
<meta name="robots" content="noodp">

<meta itemprop="name" content="xmdhs&#39;s blog">
<meta itemprop="description" content="就是一个博客">
<meta itemprop="image" content="https://avatars0.githubusercontent.com/u/20377726">

<link rel="canonical" href="https://xmdhs.top">

<link rel="shortcut icon" href="/favicon.png">
<link rel="apple-itouch-icon" href="/favicon.png">
<link rel="stylesheet" href="/bundle/index.css">
<script type="text/javascript">
    var timeSinceLang = {
        year: '年前',
        month: '个月前',
        day: '天前',
        hour: '小时前',
        minute: '分钟前',
        second: '秒前'
    };
    var root = '';
</script>


        <meta name="keywords" content="">
        <meta name="description" content="简单的弄一个站内搜索">
        <meta name="author" content="xmdhs">
        <title>简单的弄一个站内搜索</title>
    </head>
    <body>
        <article class="container">
            <header class="header-wrap">
  <a class="index" href="/">
    <img class="logo" src="https://avatars0.githubusercontent.com/u/20377726" />
    xmdhs&#39;s blog
  </a>
  <ul class="menu">
      <li class="menu-item"><a href="/archive.html">归档</a></li>
      <li class="menu-item"><a href="/tag.html">标签</a></li>
      <li class="menu-item"><a href="/atom.xml">订阅</a></li>
  </ul>
</header>

            <article class="main article">
                <h1 class="title">简单的弄一个站内搜索</h1>
                <section class="info">
                    <span class="avatar" style="background-image: url(https://avatars0.githubusercontent.com/u/20377726);"></span>
                    <a class="name" href="/about.me.html">xmdhs</a>
                    
                    <span class="date" data-time="1598950860"><span class="from"></span></span>
                    
                    <span class="tags"></span>
                </section>
                <article class="content"><p>按照惯常的博客玩法，写几篇关于折腾博客的博文，然后就再也没有更新了。</p>

<p>不过我这里并不是这样的，我这写的是之前折腾<a href="https://www.mcbbs.net/forum.php">某个论坛</a>的站内搜索，而不是博客的站内搜索，毕竟 blogger 就已经提供了一个很棒的站内搜索了。</p>

<h2>起因</h2>

<p>这个论坛因为一些原因，导致了其中的问答版块的帖子需要登录后才能查看。而论坛本身的搜索功能很差，需要登录后才能查看就导致了搜索引擎无法爬取到其中的内容。这让我有些不爽。</p>

<p>所以，我就自己闲着无聊用 golang 通过 discuz 的 api 爬取了问答版的所有帖子，再用 sqlite 储存，搜索。</p>

<p>其中还是踩了一些坑吧，或者说不算坑，只能算自己菜。</p>

<h2>最开始的构思</h2>

<p>一开始看 golang 的 <a href="https://github.com/mattn/go-sqlite3">sqlite 驱动</a>时，看到了 fts5，然后看到了 sqlite_icu，想着是不是可以用这个来实现一个简单的站内搜索。</p>

<p>可是测试的时候，创建数据库却总说找不到 icu 分词器，折腾了老半天，最后翻了下 <a href="https://www.sqlite.org/fts5.html">sqlite 的官方文档</a>才发现 fts5 不能用 icu，但是这个驱动却似乎只能用 fts5，实在有点搞不懂。</p>

<h2>解决的办法</h2>

<p>但是我又不想换成 mysql，毕竟多装一个软件还是挺麻烦的。网上找了找关于全文搜索的文章，发现还可以事先分词，然后弄全文索引。这样即使用不支持中文的全文索引也能搜索到想要的内容。</p>

<p>知道了办法那就好办了，又到网上找了找，golang 中用来分词的用的多的有两个。一个是用 cgo 调用 c++ 的代码，另一个是用的纯 go 编写。</p>

<p>肯定用 go 的，cgo 毕竟太麻烦。</p>

<p>我爬取问答版中帖子的数据，是先储存在 sqlite 的，所以需要做的工作仅仅是创建一个 fts5 的虚拟表，然后分词再存入就行了。</p>

<p>一开始的工作还是挺顺畅的，不过没过多久，cpu 的占用就上了 100% 左右，或许应该算正常，不过我修改了下代码，让其显示进度，结果发现卡在了一个位置上。不知道是这个分词项目的什么 bug，我也懒得去分析。然后就换成了 c++ 实现的分词。</p>

<p>c++ 的分词速度都要快了不少，不过上传到服务器运行程序时却报错 so 的版本过低。</p>

<pre><code>（./upsql: /lib64/libstdc++.so.6: version `GLIBCXX_3.4.20' not found (required by ./upsql)）
</code></pre>

<p>想想也很正常，服务器用的是 centos7.3，之前不知道听了谁的说 centos 稳定，稳定的代价就是这样了。</p>

<p>换系统就更麻烦，于是按照网上的教程一套下来，也解决了这个问题。现在回想一下，或许在另一台机子上，用 ldd 命令，查看程序的依赖库的路径，然后复制过来，或许就可以解决问题了。</p>

<h2>搜索的实现</h2>

<p>分词则是把一段文字变成用 / 分隔的文本，类似/这样/。然后存入 sqlite 中。</p>

<p>这样如果用某个词语，就能搜索到这段语句。</p>

<p>一开始的实现就是直接用用户输入的短语去搜索，如果用了一句完整的话，就搜索不到任何内容了。</p>

<p>所以我之后，把用户用来搜索的短句，也进行分词。然后根据 sqlite 的搜索语法，加上引号。</p>

<p>比如使用 <code>崩溃报告</code> 实际就会用 <code>SELECT key,subject,source FROM qafts5 WHERE qafts5 MATCH &quot;崩溃 报告&quot; ORDER BY rank LIMIT 20 OFFSET ?</code> 去进行搜索。</p>

<p>sqlite 的搜索语法认为引号包着的是短语，就可以搜索到“崩溃/报告”和“崩溃啊报告”之类的内容。但是不会搜索到“报告崩溃”。</p>

<p>之后又实现了几个简单的搜索语法，这就不需要多说了。</p>

<h2>网站界面的实现</h2>

<p>网站界面是直接偷 github 的 css，mit 开源的，也就是<del>不算偷</del>。然后用 markdown 转 html，再到其中加上一个输入框，就大功告成。</p>

<p>具体的内容也没什么好说的，想看的可以自己去看源码。</p>

<h2>总结</h2>

<p>sqlite 确实还是挺好用的，除了写入很差，读取的性能和全文搜索的速度还是非常快的。反正我弄了这个站内搜索，应该不会有什么人用，我自己一个人够用就行了，不会碰到性能问题的。更何况我也只租的起一核的小鸡。</p>

<h2>开源地址</h2>

<p><a href="https://github.com/xmdhs/searchqanda">https://github.com/xmdhs/searchqanda</a></p>

<p>网站地址则是 <a href="https://files.xmdhs.top/search">https://files.xmdhs.top/search</a></p>
</article>
                <section class="author">
                    <div class="avatar" style="background-image: url(https://avatars0.githubusercontent.com/u/20377726);"></div>
                    <a class="name" href="/about.me.html">xmdhs</a>
                    <div class="intro"></div>
                </section>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/7.html">对于博客的一点点折腾</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/9.html">第一篇博文</a>
                    </section>
                    
                </section>
                
<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script><script>anchors.add();</script>
<div id="disqus_thread"></div>
<script type="text/javascript">
    function loadDisqus() {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmdhs-1.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    }

    var runningOnBrowser = typeof window !== "undefined";
    var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
    var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

    setTimeout(function () {
        if (!isBot && supportsIntersectionObserver) {
            var disqus_observer = new IntersectionObserver(function (entries) {
                if (entries[0].isIntersecting) {
                    loadDisqus();
                    disqus_observer.disconnect();
                }
            }, { threshold: [0] });
            disqus_observer.observe(document.getElementById('disqus_thread'));
        } else {
            loadDisqus();
        }
    }, 1);
    
</script>
            </article>
        </article>
        <footer class="footer">
    <span class="copyright">
        xmdhs&#39;s blog ©
        <script type="text/javascript">
            document.write(new Date().getFullYear());
        </script>
    </span>
    <span class="publish">Powered by <a href="https://github.com/InkProject/ink" target="_blank">Ink</a></span>
</footer>

        <script src="/bundle/index.js"></script>
    </body>
</html>
